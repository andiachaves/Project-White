---
title: "BRMS test model"
author: "Andia Chaves Fonnegra"
date: "10/24/2017"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r setup, include=FALSE, warnings=FALSE}
library(knitr)
opts_knit$set(root.dir='../')                     # definining working directory; or normalizePath('../')
opts_chunk$set(fig.align='center',                # aligns all figures
                echo=TRUE,                        # shows r-code
                message=FALSE,                    # suppresses library outputs
                warnings=FALSE,                   # suppresses library outputs
                tidy=TRUE,  # prevents the source code from running off a pdf page
                dev='pdf')                        # pdf device
```

#Introduction

This document provides the r-code for the white plague disease model described on the article.The model address to the objectives of this study: (1) to evaluate the annual patterns of WP disease, and (2) to identify and quantify the influence of environmental factors on WP disease prevalence using Bayesian inference. We use rstan for statistical inference (http://mc-stan.org/about/). 

#Data
The white plague prevalence data and corresponding environmental and biological variables used in this model can be downloaded from xxxxxxx. The file "whiteplague_working.RData" needs to be placed in a folder called "Data".
"

#Model

##Load libraries and create directory for results
```{r}
# Date format - forms part of names of created files or graphs
today <- format(Sys.time(), "%Y.%m.%d")


# load libraries
library(formatR)
library(StanHeaders)
library(rstan)
rstan_options(auto_write = TRUE) # automatically save the compilied Stan program
options(mc.cores = parallel::detectCores()) # execute multiple Markov chains in paral

library(MCMCpack) # rwish function
library(modeest)
library(IDPmisc)
library(ggplot2) # for graphs
library(brms) # To include auto-correlation structures in the Stan model/new package Sep 2017 

library(DHARMa) #to check models residuals
# create directory if not existing
#suppressWarnings(dir.create(file.path(getwd(),"Results/04_Rstan")))

```

## Load data
```{r}
rm(list=ls(all=TRUE))
# Load settings
load(file="data/Whiteplague_workingdata.Rdata")
ls()

#check data
dim(Whiteplague_workingdata)
head(Whiteplague_workingdata)
length(unique(Whiteplague_workingdata$Station_name))
```


# SIMPLE MODEL TEST Adding autocorelation with brms (Bayesian Regression Models using Stan)
p= autoregressive (COR) order
```{r}
temporal.autocorrelation <- brm(ill|trials(Ntot) ~ Month,
                                data=Whiteplague_workingdata,
                                family = binomial(link="logit"))

```



# COMPLEX MODEL TEST Adding autocorelation with brms (Bayesian Regression Models using Stan)
p= autoregressive (COR) order
```{r}
temporal.autocorrelation <- brm(ill|trials(Ntot) ~ Chl_sca + Cond_sca + Den_sca + Oxy_sca + Sal_sca + Turb_sca + Temp_sca + DHW_sca + Rain_sca + (1|Depth_transect),
                                data=Whiteplague_workingdata,
                                family = binomial(link="logit"),
                                autocor=cor_bsts(formula= ~Month|Station_code))

```


#ARMA MODELS NOT IMPLEMENTED WITH BINOMIAL. This does not work
```{r}
temporal.autocorrelation <- brm(ill|trials(Ntot) ~ Turb_sca + (1|Depth_transect),
                                data=Whiteplague_workingdata,
                                autocor = cor_arma(~Month|Station_code, 1, 1),
                                family = binomial(link="logit"),
                                prior = c(set_prior("normal(0,0.5)", class = "ar"),
                                set_prior("normal(0,0.5)", class = "ma")))
```


#Summary brm model

```{r}
summary(temporal.autocorrelation)
#Check for WAIk and LOOP
w1 <- WAIC(temporal.autocorrelation)
w1
summary(temporal.autocorrelation, waic = TRUE) 
```

#Stan code
```{r}
stancode(temporal.autocorrelation)
```

#plot
```{r}
stanplot(object = temporal.autocorrelation)
```

#extract residuals from model
```{r}
res <- residuals( temporal.autocorrelation, summary = TRUE)
res
```

#Check model residuals with Dharma

```{r}
#The scaled (quantile) residuals are calculated with the simulateResiduals() function
#What the function does is a) creating n new synthetic datasets by simulating from the fitted model, b) calculates the cumulative distribution of simulated values for each observed value, and c) returning the quantile value that corresponds to the observed value.
simulationOutput <- simulateResiduals(fittedModel = temporal.autocorrelation, n = 250)

#The calculated residuals are stored in
simulationOutput$scaledResiduals

#For a correctly specified model we would expect a uniform (flat) distribution of the overall residuals uniformity in y direction if we plot against any predictor.

plotSimulatedResiduals(simulationOutput = simulationOutput)

#goodness of fit test
testUniformity(simulationOutput = simulationOutput)

```

#### Spatial autocorrelation of residuals
```{r}
#test Spatial autocorrelation Moran's I

# Problem repeating sites result in 0 distances!
library(dplyr)
df <- data.frame(scaledResiduals=simulationOutput$scaledResiduals,x=Whiteplague_workingdata$Latitude,y=Whiteplague_workingdata$Longitude)

# 1 option - group and mean

dfNew <- as.data.frame(df %>%
  group_by(x, y) %>%
  summarize(scaledResiduals = mean(scaledResiduals, na.rm = TRUE)))

testSpatialAutocorrelation(simulationOutput = dfNew, x = dfNew$x,y = dfNew$y)

# 2. option - random noise
df$x_new <- rnorm(df$x,df$x,0.001)
df$y_new <- rnorm(df$y,df$y,0.001)

testSpatialAutocorrelation(simulationOutput = df, x = df$x_new,y = df$y_new)
```

Both tests indicate that we should reject the null of no spatial auto-correlation. There is spatial autocorrelation.

### Test for residuals temporal autocorrelation
```{r}
# test temporal autocorrelation Durbin-Watson test in the residuals
#Month
testTemporalAutocorrelation(simulationOutput = df, time = Whiteplague_workingdata$Month_12, plot=T)
#Year
testTemporalAutocorrelation(simulationOutput = df, time = Whiteplague_workingdata$Year, plot=T)
#Seasons
testTemporalAutocorrelation(simulationOutput = df, time = Whiteplague_workingdata$Season, plot=T)
#Time points
testTemporalAutocorrelation(simulationOutput = df, time = Whiteplague_workingdata$Time_point, plot=T)
#Random time
#testTemporalAutocorrelation(simulationOutput = df, time = "random")

```




#----------------------------
#test example Tutorial 8.3b
```{r}
set.seed(126)
n <- 100
a <- 40  #intercept
b <- 1.5  #slope
x <- round(runif(n,1,n),1)  #values of the year covariate
time <- 1:n
sigma <- 20
rho <- 0.8
eps <- NULL
# first value cant be autocorrelated
eps[1] <- rnorm(1,0,sigma)
for (j in 2:n) {
  eps[j] <- rho*eps[j-1] + rnorm(1, mean = 0, sd = sigma)  #residuals
}

y <- a + b * x + eps  #response variable
#OR
y <- (model.matrix(~x) %*% c(a,b))+eps
data.temporalCor <- data.frame(y=round(y,1), x, time)  #dataset
head(data.temporalCor)  #print out the first six rows of the data set
     
#scatterplot of y against x
library(car)
scatterplot(y~x, data.temporalCor)

data.temporalCor.brm <- brm(y~x, autocor=cor_ar(~time), data=data.temporalCor, family='gaussian')
```
Summary test


```{r}
summary(data.temporalCor.brm)
#Check for WAIk and LOOP
w1 <- WAIC(data.temporalCor.brm)
w1
summary(data.temporalCor.brm, waic = TRUE) 
```




#--------------------------------
#test example 2 from github
#Paul Burkner example epilepsy data test
```{r}
library(brms)
```


#data epilepsy from brms package. Model runs

```{r}
fit <- brm(count ~ log_Age_c + log_Base4_c * Trt_c + (1|patient) + (1|obs), 
           data = epilepsy, family = "poisson")
#> Compiling the C++ model
#> Start sampling
```

#Summary model
```{r}
summary(fit, waic = TRUE) 
res <- residuals( fit, summary = TRUE)
res
```


