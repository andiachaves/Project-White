---
title: "Environmental drivers of white plague disease on shallow and mesophotic coral reefs, U.S. Virgin Islands"
author: 
-name:"Andia Chaves Fonnegra and Bernd Panassiti"
  affiliation: University of the Virgin Islands (US.VI) and Laimburg Research Center (Italy)
  abstract: "This document provides the r-code for the white plague disease model described on the article:"Environmental drivers of white plague disease on shallow and mesophotic coral reefs, U.S. Virgin Islands" Description of the model in terms of data collection, white plague disease, parameter estimations and fitting of the model can be found in Appendix A."
  keywords: white plague, coral reefs, bayesian model, environment
date: "7/18/2017"
output: pdf_document
number_sections: yes
    toc: yes
header-includes: \usepackage{graphicx}
email: \email{}
---

```{r setup, include=FALSE, warnings=FALSE}
library(knitr)
opts_knit$set(root.dir='../')                     # definining working directory; or normalizePath('../')
opts_chunk$set(fig.align='center',                # aligns all figures
                echo=TRUE,                        # shows r-code
                message=FALSE,                    # suppresses library outputs
                warnings=FALSE,                   # suppresses library outputs
                tidy=TRUE,  # prevents the source code from running off a pdf page
                dev='pdf')                        # pdf device
```

#Introduction

This document provides the r-code for the white plague disease model described on the article.The model address to the objectives of this study: (1) to evaluate the annual patterns of WP disease, and (2) to identify and quantify the influence of environmental factors on WP disease prevalence using Bayesian inference. We use rstan for statistical inference (http://mc-stan.org/about/). 

#Data
The white plague prevalence data and corresponding environmental and biological variables used in this model can be downloaded from xxxxxxx. The file "whiteplague_working.RData" needs to be placed in a folder called "Data".
"

#Model

##Load libraries and create directory for results
```{r}
# Date format - forms part of names of created files or graphs
today <- format(Sys.time(), "%Y.%m.%d")


# load libraries
library(formatR)
library(StanHeaders)
library(rstan)
rstan_options(auto_write = TRUE) # automatically save the compilied Stan program
options(mc.cores = parallel::detectCores()) # execute multiple Markov chains in paral

library(MCMCpack) # rwish function
library(modeest)
library(IDPmisc)
library(ggplot2) # for graphs
library(brms) # To include auto-correlation structures in the Stan model/new package Sep 2017 
library(brm)
library(DHARMa) #to extract posterior

# create directory if not existing
#suppressWarnings(dir.create(file.path(getwd(),"Results/04_Rstan")))

```

## Load data
```{r}
rm(list=ls(all=TRUE))
# Load settings
source("r-code/00_settings.r")

load(file="data/Whiteplague_workingdata.Rdata")


#check data
dim(Whiteplague_workingdata)
head(Whiteplague_workingdata)
length(unique(Whiteplague_workingdata$Station_name))
```

## Data preparation
```{r}
Environment <- Whiteplague_workingdata[,c("Depth_tran_sca","Turb_sca")]

# Predictors biological data, all are % of cover in transects. No need to scale?
#Orbicellids = Whiteplague_workingdata$Orbicellids
#Sand = Whiteplague_workingdata$Sand
#Coral = Whiteplague_workingdata$Coral
#Sponges = Whiteplague_workingdata$Sponges    
#Macroalgae = Whiteplague_workingdata$Macroalgae
#Cyanobacteria = Whiteplague_workingdata$Cyanobacteria    

#Time and location factors 
Year=Whiteplague_workingdata$Year
Year[Year==2012] <- 1
Year[Year==2013] <- 2
Year[Year==2014] <- 3
Year[Year==2015] <- 4
Month=Whiteplague_workingdata$Month_12

#Month=rep(1:12,c(3,25,26,29,22,4,7,29,30,14,25,25))  # Total of 12 months, with different sampling per month over 2-4 years

Season=Whiteplague_workingdata$Season
Season[Season==1] <- 1
Season[Season==2] <- 2
Season[Season==3] <- 3
Season[Season==4] <- 4
Station=Whiteplague_workingdata$Station_name
Reef.Type=Whiteplague_workingdata$Reef.Type
Latitude=Whiteplague_workingdata$Latitude
Longitude=Whiteplague_workingdata$Longitude
Timepoint=Whiteplague_workingdata$TimePoint

Site <- as.numeric(Whiteplague_workingdata$Station_name)
Site[Site==1] <- 1
Site[Site==2] <- 2
Site[Site==3] <- 3
Site[Site==4] <- 4
Site[Site==5] <- 5
Site[Site==6] <- 6
Site[Site==7] <- 7
Site[Site==8] <- 8
Site[Site==9] <- 9
Site[Site==10] <- 10
Site[Site==11] <- 11
Site[Site==12] <- 12
Site[Site==13] <- 13


#Subset per stations to later calculate temporal autocorrelation function
BlackPoint <- Whiteplague_workingdata[which(Whiteplague_workingdata$Station_code=='BPT'), ]
BrewersBay <- Whiteplague_workingdata[which(Whiteplague_workingdata$Station_code=='BWR'), ]
CasCayOuter <- Whiteplague_workingdata[which(Whiteplague_workingdata$Station_code=='CSC'), ]
CollegeShoal <- Whiteplague_workingdata[which(Whiteplague_workingdata$Station_code=='CSE'), ]
EastFrenchCap <-Whiteplague_workingdata[which(Whiteplague_workingdata$Station_code=='EFC'), ]
FlatCay <- Whiteplague_workingdata[which(Whiteplague_workingdata$Station_code=='FLC'), ]
GrammanikBank <- Whiteplague_workingdata[which(Whiteplague_workingdata$Station_code=='GKT'), ]
MCDS166 <- Whiteplague_workingdata[which(Whiteplague_workingdata$Station_code=='HKA'), ]
MeriShoal <- Whiteplague_workingdata[which(Whiteplague_workingdata$Station_code=='MSR'), ]
HindBank <- Whiteplague_workingdata[which(Whiteplague_workingdata$Station_code=='HBE'), ]
Perseverance <- Whiteplague_workingdata[which(Whiteplague_workingdata$Station_code=='PSV'), ]
SouthCapella <- Whiteplague_workingdata[which(Whiteplague_workingdata$Station_code=='SCP'), ]
Seahorse <- Whiteplague_workingdata[which(Whiteplague_workingdata$Station_code=='SHR'), ]
```


## Model definition
```{r}
dataList = list(
        TotalObservedcolonies = Whiteplague_workingdata$Ntot, #Total observed colonies Shallow (2 years) Deep (4 years)
        Diseasedcolonies = Whiteplague_workingdata$ill, # Total numer of disease colonies Shallow (2 years) Deep (4 years)
        nWP = length(Whiteplague_workingdata$Plague), #White Plague prevalence total number of rows
        observedWpPrevalence = Whiteplague_workingdata$Plague, # Total Prevalence of White Plague Shallow (2 years) Deep (4 years)
        
        Obs = 1 : length(Whiteplague_workingdata$Ntot),
        
        Environment = Environment,
        nEnvi = ncol(Environment),

        Month = Month,
        nMonth = length(unique(Month)), #number of months of WP observations Shallow (2 years) Deep (4 years)
        
        Site = Site,
        nSite =length(unique(Site)),
        
        Year = Year,
        nYear =length(unique(Year)),
        
        Season=Season,
        nSeason = length(unique(Season)),
        
        Timepoint= Timepoint,
        nTimepoint = length(unique(Timepoint))
)
```


## Model definition
```{r define model}
# Define model
model.Wplague <- '
data {
// counters
int<lower=0> nWP;                      // number of White Plague cases, int=integer  and non negative >0
int<lower=1> nEnvi;                    // number of environmental variables
// Number of Level-2 (Months)
int<lower=1> nMonth;
int<lower=1,upper=12> Month[nWP];  // month of each observation
// Number of Level-3 (Sites)
int<lower=1> nSite;               // number of sites
int<lower=1,upper=13> Site[nWP];  // sites
// Number of Level-1
int<lower=1,upper=239> Obs[nWP];  // observations
// Number of seasons
int<lower=1> nSeason;               // number of seasons
int<lower=1,upper=4> Season[nWP];  // seasons
// Number of years
int<lower=1> nYear;               // number of years
int<lower=1,upper=4> Year[nWP];  // years
// predictors
matrix[nWP, nEnvi] Environment;
// response
int<lower=0> TotalObservedcolonies [nWP]; // Total number of coral colonies (cases)
int<lower=0> Diseasedcolonies [nWP]; // number of diseased coral colonies (successes)
}
parameters {
// parameters that will be used in the model should be defined here
// these will be saved and printed with the output
//Population intercept (a real number)
real b0; // intercept
// Fixed effects
vector[nEnvi] parEnvironment;   // Environmental-level
// Random effects
real<lower=0> sigmalev1;
real<lower=0> sigmalev2;
real<lower=0> sigmalev3;
real<lower=0> sigmalev4;
real<lower=0> sigmalev5;
vector[nSite] eta1;
vector[nMonth] eta2;
vector[nWP] eta3;
vector[nSeason] eta4;
vector[nYear] eta5;
}
transformed parameters {
real RealDisease[nWP];
vector[nSite] site_raw;
vector[nMonth] month_raw;
vector[nWP] obs_raw;
vector[nSeason] season_raw;
vector[nYear] year_raw;
site_raw  = sigmalev1 * eta1;
month_raw = sigmalev2 * eta2;
obs_raw = eta3;
season_raw = sigmalev4 * eta4;
year_raw = sigmalev5 * eta5;
for (i in 1:nWP) {
RealDisease[i] =  Environment[i] * parEnvironment + site_raw[Site[i]]+month_raw[Month[i]]+obs_raw[Obs[i]];

} //closes loop observations
} //closes transformed parameter
model{
// Fixed effects priors
b0~ normal(0, 100 );
parEnvironment ~ normal(0, 100 );
//Random effects priors
eta1 ~ normal(0, 100);
eta2 ~ normal(0, 100);
eta3 ~ normal(0, 0.4);
eta4 ~ normal(0, 100);
eta5 ~ normal(0, 100);
sigmalev1 ~ cauchy(0, 2.5*2.149681);
sigmalev2 ~ cauchy(0, 2.5*2.149681);
sigmalev3 ~ cauchy(0, 2.5*2.149681);
sigmalev4 ~ cauchy(0, 2.5*2.149681);
sigmalev5 ~ cauchy(0, 2.5*2.149681);
Diseasedcolonies ~ binomial_logit(TotalObservedcolonies,RealDisease);
}
//predictive inference
generated quantities{
real DiseasePredictions[nWP]; //vector to store predictions
for( i in 1:nWP ) {
DiseasePredictions [i] = binomial_rng(TotalObservedcolonies[i],inv_logit(RealDisease[i]));
}
}
'
```


## Running the model
```{r test_run,echo=FALSE,eval=FALSE}

#This is a short test I run before running the full model, just to check its ok. I do not save this one.
stan.test <- stan(model_code = model.Wplague, data = dataList, iter = 50, chains = 3,refresh=1)

```

```{r model_run,eval=FALSE}
#This is the run of the model.
time <- proc.time()
set.seed(2017)
stan.white <- stan(model_code = model.Wplague, data = dataList, iter = 2000, chains = 4,refresh=1)
(proc.time() - time)/60/60
```


#Save the model run results
```{r}
save(stan.white, file =paste("data/2017.11.15a_Whiteplague_model_result.Rdata",sep=""))
```




```{r Extract_posterior}
# # extract entire posterior; all parameters
posterior<-extract(stan.white,inc_warmup=F,permute=F)

Ntot <- Whiteplague_workingdata$Ntot
observedWhitePlague <- Whiteplague_workingdata$ill

# FITTED PREDICTED
modelPredictions <- NULL
modelPredictions<-apply(posterior, MARGIN=1:2, FUN = function(draw) draw[grepl("^RealDisease[\\[]",names(draw))])

# combine 4 chains
predictionsLinearWhitePlague <- NULL
predictionsLinearWhitePlague <- cbind(modelPredictions[,,1], modelPredictions[,,2], modelPredictions[,,3], modelPredictions[,,4]) #  combining chains, see also: combine.mcmc from runjags package
predictionsResponseMedianWhitePlague <- inv.logit(as.vector(apply(predictionsLinearWhitePlague, 1, median)))*Ntot

# SIMULATED
modelPredictions <- NULL
modelPredictions<-apply(posterior, MARGIN=1:2, FUN = function(draw) draw[grepl("^DiseasePredictions[\\[]",names(draw))])

# combine 4 chains
simulatedPredictedWhitePlague <- NULL
simulatedPredictedWhitePlague <- cbind(modelPredictions[,,1], modelPredictions[,,2], modelPredictions[,,3], modelPredictions[,,4]) #  combining chains, see also: combine.mcmc from runjags package


WhitePlagueDHARMaResponse <- createDHARMa(simulatedResponse = simulatedPredictedWhitePlague,
  observedResponse = observedWhitePlague,fittedPredictedResponse = predictionsResponseMedianWhitePlague,integerResponse = T)
```



```{r}
plotSimulatedResiduals(simulationOutput = WhitePlagueDHARMaResponse)
```


###Test overdispersion
```{r}
#testOverdispersion(simulationOutput = WhitePlagueDHARMaResponse)
```
###Test zero inflation
```{r}
#testZeroInflation(WhitePlagueDHARMaResponse)
```











#Save the model run results
```{r}
save(stan.white, file =paste("data/2017.11.14e_Whiteplague_model_result.Rdata",sep=""))
```

# Session information for model run
```{r}
devtools::session_info()
```


#Plotting the model
```{r ploting from stan to ggmcmc}

print(stan.white)



plot(stan.white)

str(stan.white)

library(ggmcmc)
library(coda)

#This is to Install Stan Caterpillar StanCat to build caterpillar graphs from Stan
#devtools::install_github('christophergandrud/StanCat')
StanCat::stan_caterpillar(stan.white, pars = 'v_raw\\[.*\\]')

#To use ggmcmc#the rstan::extract, specify that is extracted from rstan procedure and not from dpylr
library(plyr)
#this one extracts everything but is not plotting histograms properly
s <- rstan::extract(stan.white, inc_warmup=FALSE, permuted=FALSE) 
#this one extracts only some functions

s <- mcmc.list(mcmc(s[,1,-4]), mcmc(s[,2,-4]), mcmc(s[,3,-4]), mcmc(s[,4,-4]))
S <- ggs(s) 
ggmcmc(S)
ggs_traceplots(S)
ggs_caterpillar(S)


#for specific parameters. But is not runing
#s <- rstan::extract(stan.white, pars = 'v_raw', permuted = TRUE)$parEnvironment 
#s <- do.call(mcmc.list, alply(s[,,-4], 2, mcmc))

```

#Check model output with Shiny
```{r extract with shiny}
library(shiny)
library(shinystan)

launch_shinystan(stan.white2)
```


#Save r markdown file
```{r-To save the r markdown file}

save(dataList, stan.white, file = paste("Figures/", today, "_fit.fullModel.pdf",
sep = ""))
save(dataList, file = paste("Figures/", today, "_fit.fullModel_data.Rdata",
sep = ""))
library(lattice)
trellis.device("pdf", file = paste("Figures/", today, "_Output_rstan.pdf",
sep = ""), width = 14, height = 7)
plot(stan.white)
dev.off()


library(lattice)
trellis.device("pdf")
file= paste("Figures/",today,"_Output_rstan.pdf",sep="2-2016", width=14, height=7)
plot(stan.white)
```
