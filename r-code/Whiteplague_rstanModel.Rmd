---
title: "Environmental drivers of white plague disease on shallow and mesophotic coral reefs, U.S. Virgin Islands"
author: 
-name:"Andia Chaves Fonnegra and Bernd Panassiti"
  affiliation: University of the Virgin Islands (US.VI) and Laimburg Research Center (Italy)
  abstract: "This document provides the r-code for the white plague disease model described on the article:"Environmental drivers of white plague disease on shallow and mesophotic coral reefs, U.S. Virgin Islands" Description of the model in terms of data collection, white plague disease, parameter estimations and fitting of the model can be found in Appendix A."
  keywords: white plague, coral reefs, bayesian model, environment
date: "7/18/2017"
output: pdf_document
number_sections: yes
    toc: yes
header-includes: \usepackage{graphicx}
email: \email{}
---


```{r setup, include=FALSE, warnings=FALSE}
library(knitr)
opts_knit$set(root.dir='../')                     # definining working directory; or normalizePath('../')
opts_chunk$set(fig.align='center',                # aligns all figures
                echo=TRUE,                        # shows r-code
                message=FALSE,                    # suppresses library outputs
                warnings=FALSE,                   # suppresses library outputs
                tidy=TRUE,  # prevents the source code from running off a pdf page
                dev='pdf')                        # pdf device
```

#Introduction

 This document provides the r-code for the white plague disease model described on the article.The model address to the objectives of this study: (1) to evaluate the annual patterns of WP disease, and (2) to identify and quantify the influence of environmental factors on WP disease prevalence using Bayesian inference. We use rstan for statistical inference (http://mc-stan.org/about/). 

#Data
The white plague prevalence data and corresponding environmental and biological variables used in this model can be downloaded from xxxxxxx. The file "whiteplaque_working.RData" needs to be placed in a folder called "data".
"

#Model

## Install Packages to run rstan in R if necessary
```{r Install apckages if required}

#Install packages and load libraries to run Stan and graphing results from Stan
if(!require(formatR))
{
  install.packages("formatR", repos = mir)
  require(formatR)
}

if(!require(StanHeaders)) 
{
  install.packages("StanHeaders", repos = mir)
  require(StanHeaders)
}

if(!require(rstan))
{
  install.packages("rstan", repos = mir)
  require(rstan)
}

if(!require(MCMCpack)) # rwish function
{
  install.packages("MCMCpack", repos = mir)
  require(MCMCpack)
}

if(!require(modeest)) 
{
  install.packages("modeest", repos = mir)
  require(modeest)
} 

if(!require(IDPmisc))
{
  install.packages("IDPmisc", repos = mir)
  require(IDPmisc)
} 

if(!require(ggplot2)) 
{
  install.packages("ggplot2", repos = mir)
  require(ggplot2)
}
if(!require(shinystan))
{
  install.packages("shinystan", repos = mir)
  require(shinystan)
}
if(!require(qtlcharts))
{
  install.packages("qtlcharts", repos = mir)
  require(qtlcharts)
}
```


##Load libraries and create directory for results
```{r}
# Date format - forms part of names of created files or graphs
today <- format(Sys.time(), "%Y.%m.%d")
set.seed(123)

# load libraries
library(formatR)
library(StanHeaders)
library(rstan)
rstan_options(auto_write = TRUE) # automatically save the compilied Stan program
options(mc.cores = parallel::detectCores()) # execute multiple Markov chains in paral

library(MCMCpack) # rwish function
library(modeest)
library(IDPmisc)
library(ggplot2) # for graphs

# create directory if not existing
#suppressWarnings(dir.create(file.path(getwd(),"Results/04_Rstan")))

```

## Load data
```{r}
rm(list=ls(all=TRUE))
# Load settings
load(file="Data/Whiteplague_working_data.rdata")
ls()

#check data
dim(Whiteplague_working_data)
head(Whiteplague_working_data)

```

## Data preparation
```{r}
##Selecting only Environmental variables from the file already SCALED to use in the model.
#Check in which column scaled environmental variables start.
match("Chl_sca",names(Whiteplague_working_data))
#32-42

#Selection of all 11 scaled environmental variables. 
enviroselection = White1[c(32:42)] # 
enviroselection

#Selection of Biological variables.

```


## Model definition
```{r}
#data as a list
Month=rep(1:12,c(3,25,26,29,22,4,7,29,30,14,25,25))  # Total of 12 months, with different sampling per month over 2-4 years
dataList = list(
        TotalObservedcolonies = White1$Ntot, #Total observed colonies Shallow (2 years) Deep (4 years)
        Diseasedcolonies = White1$ill, # Total numer of disease colonies Shallow (2 years) Deep (4 years)
        nWP = length(White1$Plague), #White Plague prevalence total number of rows
        observedWpPrevalence = White1$Plague, # Total Prevalence of White Plague Shallow (2 years) Deep (4 years)
        
        #Environment
        
                  Chlorophyll = White1$Chl_sca, 
                  Conductivity = White1$Cond_sca,
                  Density = White1$Den_sca,
                  CTD_Depth = White1$DepCTD_sca,    
                  Oxygen = White1$Oxy_sca,   
                  Salinity = White1$Sal_sca,    
                  Turbidity = White1$Turb_sca,    
                  Depth = White1$Depth_tran_sca,  
                  Temperature = White1$Temp_sca,   
                  Max_DHW = White1$DHW_sca  , 
                  Rainfall = White1$Rain_sca,   
        
        Environment = White1[32:(32-1+length(enviroselection))],
        nEnvi = length(enviroselection),

        Month = Month,
        nMonth = length(unique(Month)) #number of months of WP observations Shallow (2 years) Deep (4 years)
)
```


## Model definition

```{r define_model}
# Define model

model.bn.Wplague <- '
data {
// counters
int<lower=0> nWP;    //number of White Plague cases, int=integer  and non negative >0 
int<lower=0> nEnvi;  //number of environmental variables
int<lower=0> nMonth; //number of Months sampled


// predictors
matrix[nWP, nEnvi] Environment;
int<lower=0> Month[nWP];

// response
int<lower=0> TotalObservedcolonies [nWP]; // Total number of coral colonies (cases)
int<lower=0> Diseasedcolonies [nWP]; // number of diseased coral colonies (successes)
}

parameters {
// parameters that will be used in the model should be defined here
// these will be saved and printed with the output

real b0;                        // intercept
vector[nEnvi] parEnvironment;   //Environmental-level


real <lower=0> tauMonth;
vector[nMonth] v_raw;
}

transformed parameters {
// generation of derived parameters from parameters above should be defined here
// these will be saved and printed with the output


vector[nMonth] v; //month effects
real RealDisease[nWP];
vector[nWP] mu; //


for (h in 1:nMonth){
v[h] = v_raw[h]*(tauMonth);
}

for( i in 1:nWP ) {
mu[i] = v[Month[i]];
RealDisease[i]  = (b0  + Environment[i] * parEnvironment + mu[i]);
}
}


model{
// This is area for describing the model including the priors and likelihood
// This is the only place where sampling can be done within Stan
// All data and parameters used in this section must be defined above

// Fixed effects priors
b0 ~ normal(0, 100 ); //
parEnvironment ~ normal(0 , 100 );

//Hyperpriors
tauMonth  ~ inv_gamma(0.001, 0.001);    

//Random effects priors
v_raw ~ normal(0, 1);

Diseasedcolonies ~ binomial_logit(TotalObservedcolonies,RealDisease);
}


#predictive inference
#generated quantities
#{
#real DiseasePredictions[nWP]; //vector to store predictions

#for( i in 1:nWP ) {
#DiseasePredictions [i] <- binomial_rng(TotalObservedcolonies[i],inv_logit(b0  + Environment[i] * parEnvironment + mu[i]));
#}
#}
'
```

## Running the model
```{r test_run,echo=FALSE,eval=FALSE}
stan.white <- stan(model_code = model.bn.Wplague, data = dataList, iter = 1000, chains = 1,refresh=1,thin=1)
```

```{r model_run,eval=FALSE}
time <- proc.time()
set.seed(2017)
stan.white2 <- stan(model_code = model.bn.Wplague, data = dataList, iter = 30000, chains = 4,refresh=1)
(proc.time() - time)/60/60
```


# Session info
```{r}
devtools::session_info()
```


```{r ploting from stan to ggmcmc}
save(stan.white2, file ="Data/stan.white2")
print(stan.white2)
plot(stan.white2)

str(stan.white2)

library(ggmcmc)
library(coda)

#This is to Install Stan Caterpillar StanCat to build caterpillar graphs from Stan
#devtools::install_github('christophergandrud/StanCat')
StanCat::stan_caterpillar(stan.white2, pars = 'v_raw\\[.*\\]')

#To use ggmcmc#the rstan::extract, specify that is extracted from rstan procedure and not from dpylr
library(plyr)
#this one extracts everything but is not plotting histograms properly
s <- rstan::extract(stan.white2, inc_warmup=FALSE, permuted=FALSE) 
#this one extracts only some functions

s <- mcmc.list(mcmc(s[,1,-4]), mcmc(s[,2,-4]), mcmc(s[,3,-4]), mcmc(s[,4,-4]))
S <- ggs(s) 
ggmcmc(S)
ggs_traceplots(S)
ggs_caterpillar(S)


#for specific parameters. But is not runing
#s <- rstan::extract(stan.white, pars = 'v_raw', permuted = TRUE)$parEnvironment 
#s <- do.call(mcmc.list, alply(s[,,-4], 2, mcmc))

```

```{r-To save the r markdown file}

save(dataList, stan.white, file = paste("Figures/", today, "_fit.fullModel.pdf",
sep = ""))
save(dataList, file = paste("Figures/", today, "_fit.fullModel_data.Rdata",
sep = ""))
library(lattice)
trellis.device("pdf", file = paste("Figures/", today, "_Output_rstan.pdf",
sep = ""), width = 14, height = 7)
plot(stan.white)
dev.off()


library(lattice)
trellis.device("pdf")
file= paste("Figures/",today,"_Output_rstan.pdf",sep="2-2016", width=14, height=7)
plot(stan.white)
```

```{r extract with shiny}
library(shiny)
library(shinystan)
launch_shinystan(stan.white2)
```


#From Panassiti et al., 2016
#Extraction of residuals from the posterior of a stan-object
#At first rstan package is loaded and the entire posterior with all parameters extracted

```{r}
library(rstan)
posterior<-extract(stan.white2,inc_warmup=F,permute=F) # extraction of posterior
```

Extraction of posterior predictive simulations.
```{r}
# real White Plague Prevalence Predictions are simulated (predictions generated in the
# Generated quantities block of the model code)
modelPredictions<-apply(posterior, MARGIN=1:2, FUN = function(draw)
draw[grepl("^RealDisease[\\[]",names(draw))])

# combine 4 chains
simulatedPredictedWP <- NULL
simulatedPredictedWP <- cbind(modelPredictions[,,1], modelPredictions[,,2],
modelPredictions[,,3], modelPredictions[,,4]) # combining chains
```


Extraction of median model predictions on the response scale
```{r}
#library(LaplacesDemon)
#library(arm) 
#library(boot)

# Real WP prevalence Predictions (are the predictions on the linear scale which are
# transformed in a 2. step to be on the response scale (inv.logit()))
modelPredictions <- NULL
modelPredictions<-apply(posterior, MARGIN=1:2, FUN = function(draw)
draw[grepl("^RealDisease[\\[]",names(draw))])
# combine 4 chains
predictionsLinearWP <- NULL
predictionsLinearWP <- cbind(modelPredictions[,,1], modelPredictions[,,2],
modelPredictions[,,3], modelPredictions[,,4]) # combining chains
predictionsResponseWPMedian <-inv.logit(as.vector(apply(predictionsLinearWP, 1, median)))*White1$Plague # I think is WP prevalence and not ill here for White1$Plague..mmm? This one worked
```

Residual diagnosis
```{r}
#devtools::install_github(repo = "DHARMa", username = "florianhartig",
#subdir = "DHARMa", dependencies = T, build_vignettes = TRUE)
library(DHARMa)
library(optimx)

ObservedWP<-White1$Plague

WP_DHARMaResponse <- createDHARMa(
simulatedResponse = simulatedPredictedWP,
observedResponse = ObservedWP,
fittedPredictedResponse = predictionsResponseWPMedian,
integerResponse = T) # interger correction function

#Plots
plotSimulatedResiduals(simulationOutput = WP_DHARMaResponse)

#test Spatial autocorrelation Moran's I
testSpatialAutocorrelation(WP_DHARMaResponse , x = White1$Latitude,
y = White1$Longitude)

```

