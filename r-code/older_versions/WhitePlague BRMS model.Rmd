---
title: "BRMS test model"
author: "Andia Chaves Fonnegra"
date: "10/24/2017"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r setup, include=FALSE, warnings=FALSE}
library(knitr)
opts_knit$set(root.dir='../')                     # definining working directory; or normalizePath('../')
opts_chunk$set(fig.align='center',                # aligns all figures
                echo=TRUE,                        # shows r-code
                message=FALSE,                    # suppresses library outputs
                warnings=FALSE,                   # suppresses library outputs
                tidy=TRUE,  # prevents the source code from running off a pdf page
                dev='pdf')                        # pdf device
```

#Introduction

This document provides the r-code for the white plague disease model described on the article.The model address to the objectives of this study: (1) to evaluate the annual patterns of WP disease, and (2) to identify and quantify the influence of environmental factors on WP disease prevalence using Bayesian inference. We use rstan for statistical inference (http://mc-stan.org/about/). 

#Data
The white plague prevalence data and corresponding environmental and biological variables used in this model can be downloaded from xxxxxxx. The file "whiteplague_working.RData" needs to be placed in a folder called "Data".
"

#Model

##Load libraries and create directory for results
```{r}
# Date format - forms part of names of created files or graphs
today <- format(Sys.time(), "%Y.%m.%d")


# load libraries
library(formatR)
library(StanHeaders)
library(rstan)
rstan_options(auto_write = TRUE) # automatically save the compilied Stan program
options(mc.cores = parallel::detectCores()) # execute multiple Markov chains in paral

library(MCMCpack) # rwish function
library(modeest)
library(IDPmisc)
library(ggplot2) # for graphs
library(brms) # To include auto-correlation structures in the Stan model/new package Sep 2017 

library(DHARMa) #to check models residuals
# create directory if not existing
#suppressWarnings(dir.create(file.path(getwd(),"Results/04_Rstan")))
library(lmtest) # for Durbin-Watson test
```

## Load data
```{r}
rm(list=ls(all=TRUE))
# Load settings
load(file="data/Whiteplague_workingdata.Rdata")
ls()

#check data
dim(Whiteplague_workingdata)
head(Whiteplague_workingdata)
length(unique(Whiteplague_workingdata$Station_name))


Whiteplague_workingdata$obsid <- as.factor(1:nrow(Whiteplague_workingdata))
```


# SIMPLE MODEL TEST Adding autocorelation with brms (Bayesian Regression Models using Stan)
p= autoregressive (COR) order
```{r}
stan.white <- brm(ill|trials(Ntot) ~ Sal_sca,
                                data=Whiteplague_workingdata,
                                family = binomial(link="logit"))
```



# COMPLEX MODEL TEST Adding autocorelation with brms (Bayesian Regression Models using Stan)
p= autoregressive (COR) order
```{r}
stan.white <- brm(ill|trials(Ntot) ~ Chl_sca,
                                data=Whiteplague_workingdata,
                                family = binomial(link="logit"),
                                 autocor = cor_bsts(formula=~obsid))

```


#adding month as random effects. obsid (1|N) being N each site

```{r}
stan.white <- brm(ill|trials(Ntot) ~ Chl_sca + (1|Month),
                                data=Whiteplague_workingdata,
                                family = binomial(link="logit"),
                                 autocor = cor_bsts(formula=~obsid))
```

#Month as fixed predictor

```{r}
stan.white <- brm(ill|trials(Ntot) ~ Month,
                                data=Whiteplague_workingdata,
                                family = binomial(link="logit"),
                                 autocor = cor_bsts(formula=~obsid))
```

#Interaction of Month and Chl


```{r}
stan.white <- brm(ill|trials(Ntot) ~ Chl_sca * Month,
                                data=Whiteplague_workingdata,
                                family = binomial(link="logit"),
                                 autocor = cor_bsts(formula=~obsid))
```


#model E3 as for GLMER without autocorrelation function
```{r}
stan.white <- brm(ill|trials(Ntot) ~ Depth_tran_sca + Turb_sca + (1|Station_name/Month_12),
                                data=Whiteplague_workingdata,
                                family = binomial(link="logit"))
```

#model as E3 for GLMER wit autocorrelation function. BEST MODEL UNTIL NOW
```{r}
stan.white <- brm(ill|trials(Ntot) ~ Depth_tran_sca  + Turb_sca + (1|Station_name/Month_12),
                                data=Whiteplague_workingdata,
                                family = binomial(link="logit"),
                                autocor = cor_bsts(formula=~obsid))
```


#GLMES examples that worked
```{r}
#Month nested within site. Intercept varying among sites and months within sites
E3 <- glmer(cbind(ill,Ntot-ill) ~ Depth + Turbidity + (1|Site/Month) ,family="binomial"(link = "logit"))
summary(E3)

#combination of effect of mont and site nested within season. works good, still some
E4 <- glmer(cbind(ill,Ntot-ill) ~ Depth + Turbidity + (1|Season/Month:Site) ,family="binomial"(link = "logit"))
summary(E4)
```


#model E4 as for GLMER without autocorrelation function
```{r}
stan.white <- brm(ill|trials(Ntot) ~ Depth_tran_sca + Turb_sca + (1|Season/Month_12:Station_name),
                                data=Whiteplague_workingdata,
                                family = binomial(link="logit"))
```

#model as E4 for GLMER wit autocorrelation function
```{r}
stan.white <- brm(ill|trials(Ntot) ~ Depth_tran_sca + Turb_sca + (1|Season/Month_12:Station_name),
                                data=Whiteplague_workingdata,
                                family = binomial(link="logit"),
                                autocor = cor_bsts(formula=~obsid))
```


#model as E4 for GLMER wit autocorrelation function
```{r}
stan.white <- brm(ill|trials(Ntot) ~ Depth_transect + Turb_sca + (1|Month),
                                data=Whiteplague_workingdata,
                                family = binomial(link="logit"),
                                autocor = cor_bsts(formula=~~obsid))
```


#model  with only month as random to test with glmer and glmer2stan
#Both Depth and Turbidity as scaled variables.
```{r}
stan.white <- brm(ill|trials(Ntot) ~ Depth_tran_sca + Turb_sca + (1|Month_12),
                                data=Whiteplague_workingdata,
                                family = binomial(link="logit"))
```


#model as E3 for GLMER wit autocorrelation function, adding other variables
```{r}
stan.white <- brm(ill|trials(Ntot) ~ Depth_tran_sca  + Turb_sca + Chl_sca +Temp_sca+ DHW_sca+ Cond_sca + Den_sca + DepCTD_sca+ Oxy_sca+Sal_sca+ Orbicellids +(1|Station_name/Month_12),
                                data=Whiteplague_workingdata,
                                family = binomial(link="logit"),
                                autocor = cor_bsts(formula=~obsid))
```




#Save the model run results
```{r}
save(stan.white, file =paste("data/2017.10.25a_Whiteplague_model_result.Rdata",sep=""))

```




#Summary brm model

```{r}
summary(stan.white)
#Check for WAIk and LOOP
w1 <- WAIC(stan.white)
w1
w2 <-LOO(stan.white)
w2

```

#Stan code
```{r}
stancode(stan.white)
```

#plot
```{r}
stanplot(object = stan.white)
```

#extract residuals from model
```{r}
res <- residuals(stan.white, summary = TRUE)
res
```

#Check residuals
```{r}
Resid.brm <- residuals(stan.white, type='pearson')
Fitted.brm <- fitted(stan.white, scale='linear')
ggplot(data=NULL, aes(y=Resid.brm[,'Estimate'], x=Fitted.brm[,'Estimate'])) + geom_point()

#to scale btw 0 and 1:


#qqnorm test
qqnorm(Resid.brm, ylab="Standardized Residuals", xlab="Normal Scores") 
qqline(Resid.brm)
#goodness of fit test

```

#
```{r}
white<-stan.white$fit
plot(white)
stan_ac(white)
#Chains
stan_trace(white, "lp__")

#Rhat has to be 1
stan_rhat(white)
#Montecarlo Standard error
stan_mcse(white)
```

#qqnorm for residuals

```{r}

plot(Resid.brm)  # Plot the model information
```



#----------------------------
#test example Tutorial 8.3b
```{r}
set.seed(126)
n <- 100
a <- 40  #intercept
b <- 1.5  #slope
x <- round(runif(n,1,n),1)  #values of the year covariate
time <- 1:n
sigma <- 20
rho <- 0.8
eps <- NULL
# first value cant be autocorrelated
eps[1] <- rnorm(1,0,sigma)
for (j in 2:n) {
  eps[j] <- rho*eps[j-1] + rnorm(1, mean = 0, sd = sigma)  #residuals
}

y <- a + b * x + eps  #response variable
#OR
y <- (model.matrix(~x) %*% c(a,b))+eps
data.temporalCor <- data.frame(y=round(y,1), x, time)  #dataset
head(data.temporalCor)  #print out the first six rows of the data set
     
#scatterplot of y against x
library(car)
scatterplot(y~x, data.temporalCor)

data.temporalCor.brm <- brm(y~x, autocor=cor_ar(~time), data=data.temporalCor, family='gaussian')
```
Summary test


```{r}
summary(data.temporalCor.brm)
#Check for WAIk and LOOP
w1 <- WAIC(data.temporalCor.brm)
w1
summary(data.temporalCor.brm, waic = TRUE) 
```




#--------------------------------
#test example 2 from github
#Paul Burkner example epilepsy data test
```{r}
library(brms)
```


#data epilepsy from brms package. Model runs

```{r}
fit <- brm(count ~ log_Age_c + log_Base4_c * Trt_c + (1|patient) + (1|obs), 
           data = epilepsy, family = "poisson")
#> Compiling the C++ model
#> Start sampling
```

#Summary model
```{r}
summary(fit, waic = TRUE) 
res <- residuals( fit, summary = TRUE)
res
```


