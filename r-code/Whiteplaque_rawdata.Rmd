---
title: White plaque disease - Compilation of rawdata
author: Andia Chaves Fonnegra, Bernd Panassiti
date: '08.23.2016; last modified: `r format(Sys.Date(), format="%d.%m.%Y")`'
output: 
  pdf_document: 
    number_sections: yes
    toc: yes
header-includes: \usepackage{graphicx}
email: \email{}
---

```{r setup, include=FALSE, warnings=FALSE}
library(knitr)
opts_knit$set(root.dir='../')                     # definining working directory; or normalizePath('../')
opts_chunk$set(fig.align='center',                # aligns all figures
                echo=TRUE,                        # shows r-code
                message=FALSE,                    # suppresses library outputs
                warnings=FALSE,                   # suppresses library outputs
                tidy=TRUE,  # prevents the source code from running off a pdf page
                dev='pdf')                        # pdf device
```

# Introduction
Compilation of raw data. 

# Data
# Joint model

Loading data 
```{r}
rm(list=ls(all=TRUE))
# Load settings
source('r-code/00_settings.R')


# load data & libraries - Loading Raw data file without average of ill a ntot of White Plague - made July 11-Andia 
White <- read.csv("data/Rawdata_WP_No_average_Rainmm.csv", header = TRUE) #Rainfall in mm
#check data
ls(White)
dim(White)
head(White)
```


Install Packages if necessary
```{r Install apckages if required}

#Install packages and load libraries to run Stan and graphing results from Stan
if(!require(formatR))
{
  install.packages("formatR", repos = mir)
  require(formatR)
}

if(!require(StanHeaders)) 
{
  install.packages("StanHeaders", repos = mir)
  require(StanHeaders)
}

if(!require(rstan))
{
  install.packages("rstan", repos = mir)
  require(rstan)
}

if(!require(MCMCpack)) # rwish function
{
  install.packages("MCMCpack", repos = mir)
  require(MCMCpack)
}

if(!require(modeest)) 
{
  install.packages("modeest", repos = mir)
  require(modeest)
} 

if(!require(IDPmisc))
{
  install.packages("IDPmisc", repos = mir)
  require(IDPmisc)
} 

if(!require(ggplot2)) 
{
  install.packages("ggplot2", repos = mir)
  require(ggplot2)
}
if(!require(shinystan))
{
  install.packages("shinystan", repos = mir)
  require(shinystan)
}
if(!require(qtlcharts))
{
  install.packages("qtlcharts", repos = mir)
  require(qtlcharts)
}
```

Load libraries if required

```{r}
# load libraries
library(formatR)
library(StanHeaders)
library(rstan)
library(MCMCpack) # rwish function
library(modeest)
library(IDPmisc)
library(ggplot2)
# create directory if not existing
suppressWarnings(dir.create(file.path(getwd(),"Results/04_Rstan")))

```


Data preparation.All environmental data is scaled due to difference in units, this to avoid
adding more variability in the analysis
```{r data_preparation}

White$Chl_sca   <- scale(White$Chlorophyll)
White$Cond_sca    <- scale(White$Conductivity)
White$Den_sca    <- scale(White$Density)
White$DepCTD_sca    <- scale(White$Depth_CTD)
White$Oxy_sca   <- scale(White$Oxygen)
White$Sal_sca    <- scale(White$Salinity)
White$Turb_sca    <- scale(White$Turbidity)
White$Depth_tran_sca  <- scale(White$Depth_disease_transect)
White$Temp_sca    <- scale(White$Temperature)
White$DHW_sca    <- scale(White$Max_DHW)
White$Rain_sca    <- scale(White$Rainfall)

#Simplifying syntax of factors (Year, Depth, Month, Season, Station) to use in the model
Year=White$Year
Month=White$Month_number
Season=White$Season
Station=White$Station_name
Depth=White$Depth_disease_transect

##Environmental variables include temperature and rainfall
enviroselection = c(11:13) # to select all 11 environmental variables. 
```


# Data as a list, using Month as factor
```{r}
Month=c(sort(rep(1:26,13))) # Total of 26 months (2012-2015) max, for 13 stations
dataList = list(
        TotalObservedcolonies = White$ntot,
        Diseasedcolonies = White$ill,
        nWP = length(White$White_Plague_Prevalence),
        
                  Chlorophyll = White$Chl_sca,
                  Conductivity = White$Cond_sca,
                  Density = White$Den_sca,
                  CTD_Depth = White$DepCTD_sca,    
                  Oxygen = White$Oxy_sca,   
                  Salinity = White$Sal_sca,    
                  Turbidity = White$Turb_sca,    
                  Depth = White$Depth_tran_sca,  
                  Temperature = White$Temp_sca,   
                  Max_DHW = White$DHW_sca  , 
                  Rainfall = White$Rain_sca,   
        
        Environment = White[11:(11-1+length(enviroselection))],
        nEnvi = length(enviroselection),

        Month = Month,
        nMonth = length(unique(Month))
)
```

#############

## Model definition

```{r define_model}
# Define model

model.bn.Wplague <- '
data {
// counters
int<lower=0> nWP;    //number of White Plague cases, int=integer  and non negative >0 
int<lower=0> nEnvi;  //number of environmental variables
int<lower=0> nMonth; //number of Months sampled


// predictors
matrix[nWP, nEnvi] Environment;
int<lower=0> Month[nWP];

// response
int<lower=0> TotalObservedcolonies [nWP]; // Total number of coral colonies (cases)
int<lower=0> Diseasedcolonies [nWP]; // number of diseased coral colonies (successes)
}

parameters {
// parameters that will be used in the model should be defined here
// these will be saved and printed with the output

real b0;                        // intercept
vector[nEnvi] parEnvironment;   //Environmental-level


real <lower=0> tauMonth;
vector[nMonth] v_raw;
}

transformed parameters {
// generation of derived parameters from parameters above should be defined here
// these will be saved and printed with the output


vector[nMonth] v; //month effects
real RealDisease[nWP];
vector[nWP] mu; //


for (h in 1:nMonth){
v[h] = v_raw[h]*(tauMonth);
}

for( i in 1:nWP ) {
mu[i] = v[Month[i]];
RealDisease[i]  = (b0  + Environment[i] * parEnvironment + mu[i]);
}
}


model{
// This is area for describing the model including the priors and likelihood
// This is the only place where sampling can be done within Stan
// All data and parameters used in this section must be defined above

// Fixed effects priors
b0 ~ normal(0, 100 ); //
parEnvironment ~ normal(0 , 100 );

//Hyperpriors
tauMonth  ~ inv_gamma(0.001, 0.001);    

//Random effects priors
v_raw ~ normal(0, 1);

Diseasedcolonies ~ binomial_logit(TotalObservedcolonies,RealDisease);
}


#predictive inference
#generated quantities
#{
#real DiseasePredictions[nWP]; //vector to store predictions

#for( i in 1:nWP ) {
#DiseasePredictions [i] <- binomial_rng(TotalObservedcolonies[i],inv_logit(b0  + Environment[i] * parEnvironment + mu[i]));
#}
#}
'
```

## Running the model
```{r test_run,echo=FALSE,eval=FALSE}
stan.white <- stan(model_code = model.bn.Wplague, data = dataList, iter = 1000, chains = 1,refresh=1,thin=1)
```


```{r rmd2r,echo=FALSE,eval=FALSE}
# export to .r format
if(!require(stringi)) # stri_sub function
{
  install.packages("stringi", repos = mir)
  require(stringi)
}
#' ## script for converting .Rmd files to .R scripts.

#' #### Kevin Keenan 2014
#' http://rstudio-pubs-static.s3.amazonaws.com/12734_0a38887f19a34d92b7311a2c9cb15022.html
#' 
#' This function will read a standard R markdown source file and convert it to 
#' an R script to allow the code to be run using the "source" function.
#' 
#' The function is quite simplisting in that it reads a .Rmd file and adds 
#' comments to non-r code sections, while leaving R code without comments
#' so that the interpreter can run the commands.
#' 
#' 
# library "stringi" needs to be loaded
rmd2rscript <- function(infile){
  # read the file
  flIn <- readLines(infile)
  # identify the start of code blocks
  cdStrt <- which(grepl(flIn, pattern = "```{r*", perl = TRUE))
  # identify the end of code blocks
  cdEnd <- sapply(cdStrt, function(x){
    preidx <- which(grepl(flIn[-(1:x)], pattern = "```", perl = TRUE))[1]
    return(preidx + x)
  })
  # define an expansion function
  # strip code block indacators
  flIn[c(cdStrt, cdEnd)] <- ""
  expFun <- function(strt, End){
    strt <- strt+1
    End <- End-1
    return(strt:End)
  }
  idx <- unlist(mapply(FUN = expFun, strt = cdStrt, End = cdEnd, 
                       SIMPLIFY = FALSE))
  # add comments to all lines except code blocks
  comIdx <- 1:length(flIn)
  comIdx <- comIdx[-idx]
  for(i in comIdx){
    flIn[i] <- paste("#' ", flIn[i], sep = "")
  }
  # create an output file
  #nm <- strsplit(infile, split = "\\.")[[1]][1]
  nm <- stri_sub(infile,1,-5)
  flOut <- file(paste(nm, "_rmd2r.R", sep = ""), "w")
  for(i in 1:length(flIn)){
    cat(flIn[i], "\n", file = flOut, sep = "\t")
  }
  close(flOut)
}

rmd2rscript("r-code/Simple.Hierarchical.WP.Rmd")
unloadNamespace("evaluate")
unloadNamespace("stringr")
detach("package:stringi", unload=TRUE)
```


```{r model_run,eval=FALSE}
time <- proc.time()
set.seed(2016)
stan.white <- stan(model_code = model.bn.Wplague, data = dataList, iter = 30000, chains = 4,refresh=1)
(proc.time() - time)/60/60
```




```{r ploting from stan to ggmcmc}
if(!require(ggmcmc))
{
  install.packages("ggmcmc", repos = mir)
  require(ggmcmc)
}
if(!require(coda))
{
  install.packages("coda", repos = mir)
  require(coda)
}


#This is to Install Stan Caterpillar StanCat to build caterpillar graphs from Stan
#devtools::install_github('christophergandrud/StanCat')
StanCat::stan_caterpillar(stan.white, pars = 'v_raw\\[.*\\]')

#To use ggmcmc
#the rstan::extract, specify that is extracted from rstan procedure and not from dpylr

if(!require(plyr))
{
  install.packages("plyr", repos = mir)
  require(plyr)
}

#this one extracts everything but is not plotting histograms properly
s <- rstan::extract(stan.white, inc_warmup=FALSE, permuted=FALSE) 
#this one extracts only some functions

s <- mcmc.list(mcmc(s[,1,-4]), mcmc(s[,2,-4]), mcmc(s[,3,-4]), mcmc(s[,4,-4]))
S <- ggs(s) 
ggmcmc(S)
ggs_traceplots(S)
ggs_caterpillar(S)


#for specific parameters. But is not runing
s <- rstan::extract(stan.white, pars = 'v_raw', permuted = TRUE)$parEnvironment 
s <- do.call(mcmc.list, alply(s[,,-4], 2, mcmc))

detach("package:ggmcmc")
detach("package:coda")
detach("package:plyr")
```

```{r-To save the r markdown file}
# note: folder figures synchronized in cloud (dropbox) but not results folder

save(dataList, stan.white, file = paste("results/", today, "_fit.fullModel.Rdata",sep = ""))
save(dataList, file = paste("results/", today, "_fit.fullModel_data.Rdata",sep = ""))

library(lattice)
trellis.device("pdf", file = paste("figures/", today, "_Output_rstan.pdf",
sep = ""), width = 14, height = 7)
plot(stan.white)
dev.off()
```

# Session info
```{r}
devtools::session_info()
```

